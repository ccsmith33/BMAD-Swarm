import { join } from 'node:path';
import { writeFileSafe, ensureDir } from '../utils/fs-helpers.js';

/**
 * Generate Claude Code hooks for quality gate enforcement.
 * Creates Node.js scripts in .claude/hooks/ that run on specific events.
 *
 * @param {object} config - Parsed swarm.yaml config
 * @param {object} projectPaths - Project paths from getProjectPaths()
 * @returns {string[]} List of generated hook file paths
 */
export function generateHooks(config, projectPaths) {
  ensureDir(projectPaths.hooksDir);
  const generated = [];

  const taskCompletedPath = join(projectPaths.hooksDir, 'TaskCompleted.js');
  writeFileSafe(taskCompletedPath, generateTaskCompletedHook(config));
  generated.push(taskCompletedPath);

  const teammateIdlePath = join(projectPaths.hooksDir, 'TeammateIdle.js');
  writeFileSafe(teammateIdlePath, generateTeammateIdleHook(config));
  generated.push(teammateIdlePath);

  return generated;
}

function generateTaskCompletedHook(config) {
  const enforce = config.hooks?.enforce || false;

  return `#!/usr/bin/env node
// BMAD Swarm - TaskCompleted Hook
// Generated by bmad-swarm - do not edit manually

const { execSync } = require('child_process');

const taskId = process.env.TASK_ID || '';
const taskSubject = process.env.TASK_SUBJECT || '';
const taskOwner = process.env.TASK_OWNER || '';

console.log(\`[BMAD Swarm] Task completed: \${taskSubject} (by \${taskOwner})\`);

const isImplementation = taskSubject.includes('implement') || taskSubject.includes('develop') || taskSubject.includes('dev-');

if (isImplementation) {
  try {
    execSync('npm test', { stdio: 'pipe', timeout: 60000 });
    console.log('[BMAD Swarm] \\u2713 Tests passed');
  } catch (err) {
    console.log('[BMAD Swarm] \\u2717 Tests failed');
    if (err.stdout) console.log(err.stdout.toString().slice(-500));
    ${enforce ? "process.exit(1);" : "console.log('[BMAD Swarm] Advisory: Fix failing tests before merging');"}
  }
}

process.exit(0);
`;
}

function generateTeammateIdleHook(config) {
  return `#!/usr/bin/env node
// BMAD Swarm - TeammateIdle Hook
// Generated by bmad-swarm - do not edit manually

const teammateName = process.env.TEAMMATE_NAME || '';
const teammateId = process.env.TEAMMATE_ID || '';

console.log(\`[BMAD Swarm] Teammate idle: \${teammateName}\`);

if (teammateName.includes('orchestrator')) {
  console.log('[BMAD Swarm] Warning: Orchestrator is idle - check if tasks are pending');
}

process.exit(0);
`;
}

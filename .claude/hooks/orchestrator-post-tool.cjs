#!/usr/bin/env node
// bmad-generated:ee0226c6
// BMAD Swarm - PostToolUse Enforcement Hook
// Generated by bmad-swarm - do not edit manually
//
// Fires after Edit, Write, or Bash tool calls.
// Checks if the tool modified files in the protected code directory.
// If so, injects a warning into Claude's context via additionalContext.

const fs = require('fs');
const path = require('path');

const CODE_DIR = "./src";

let input = '';
process.stdin.setEncoding('utf8');
process.stdin.on('data', (chunk) => { input += chunk; });
process.stdin.on('end', () => {
  let event;
  try {
    event = JSON.parse(input);
  } catch {
    process.exit(0);
  }

  const toolName = event.tool_name || '';
  const toolInput = event.tool_input || {};
  const cwd = event.cwd || process.cwd();

  const resolvedCodeDir = path.resolve(cwd, CODE_DIR);
  let targetPath = null;

  if (toolName === 'Edit' || toolName === 'Write') {
    targetPath = toolInput.file_path || '';
  } else if (toolName === 'Bash') {
    const cmd = toolInput.command || '';
    // Heuristic: check if the command references the code directory
    if (cmd.includes(CODE_DIR) || cmd.includes(resolvedCodeDir)) {
      targetPath = resolvedCodeDir;
    }
  }

  if (!targetPath) {
    process.exit(0);
  }

  const resolvedTarget = path.resolve(cwd, targetPath);
  if (resolvedTarget.startsWith(resolvedCodeDir)) {
    // Write a marker file so the Stop hook can detect violations
    const markerPath = path.join(cwd, '.claude', 'hooks', '.code-modified-marker');
    try {
      fs.mkdirSync(path.dirname(markerPath), { recursive: true });
      fs.writeFileSync(markerPath, JSON.stringify({
        timestamp: Date.now(),
        tool: toolName,
        file: resolvedTarget,
      }));
    } catch {
      // Best effort - marker write failure should not block
    }

    const output = JSON.stringify({
      additionalContext: 'WARNING: You just modified source code in ' + CODE_DIR + ' directly. As the orchestrator, you must delegate all implementation to developer agents. Revert this change and spawn a developer agent to handle it.',
    });
    process.stdout.write(output);
  }

  process.exit(0);
});
